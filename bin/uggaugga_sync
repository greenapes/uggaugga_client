#!/usr/bin/env python3
from uggaugga import client
import json
import sys
import os

config_path = './uggaugga_config.json'
if not os.path.exists(config_path):
    raise Exception("file ./uggaugga_config.json not found")

conf = None
with open(config_path, 'r') as fp:
    conf = json.load(fp)

DRY_RUN = False
if '--n' in sys.argv:
    DRY_RUN = True

extractors = []
for extr in conf['extractors']:

    if extr['type'] == 'TExtractor':
        extractors.append(client.TExtractor(
            root=extr['root'],
            exts=extr['extention_list'],
            custom_regex=extr.get("custom_regex")))

    elif extr['type'] == 'XgettexExtractor':
        extractors.append(client.XgettexExtractor(
            root=extr['root'],
            ext=extr['extension'],
            language=extr['language'],
            I18n_parent_key=extr['I18n_parent_key']))
        
    elif extr['type'] == 'TExtractorFlat':
        extractors.append(client.TExtractorFlat(
            root=extr['root'],
            exts=extr['extention_list'],
            text_key=extr.get('text_key'),
            I18n_parent_key=extr['I18n_parent_key'],
            custom_regex=extr.get("custom_regex")
        ))


client.config(namespace=conf['namespace'],
              connection_url=conf['server']['url'],
              public_key=conf['server']['public_key'],
              secret_key=conf['server']['secret_key'],
              supported_langs=conf['langs'],
              i18n_local_path=conf["i18n_path"],
              code_extractors=extractors)

I18N = client.sync(extract_from_code=True,
                   dry_run=DRY_RUN or conf.get('debug', False))
